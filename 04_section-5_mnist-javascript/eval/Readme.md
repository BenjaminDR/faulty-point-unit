# Evaluation

There are two evaluation scripts. One to run the tests and create outputs and one to evaluate those outputs. The run script takes the following arguments:
| Argument | Default | Description |
| :------- | :------ | :---------- |
| `--javascript` | `../js-files/convnet.js` | Defines the Javascript file to execute |
| `--neural-net` | `../js-files/trained-network.json` | Defines the neural net that is used as first input to the Javascript file. |
| `--mnist` | `../js-files/mnist_handwritten_test_first100.json` | Defines the mnist tests that are to be evaluated on the neural net. |
| `--amount` | `100` | The number of images that are picked from the mnist input.|
| `--initial` | `0` | The initial index to start from at the mnist input. This allows to run the evaluation in batches.|

## run_tests.py
The `run_test` script performs multiple executions of the sgx-duktape enclave application for each desired setting of the FPU and stores the outputs in a subdirectory. These outputs can then be evaluated in the next step by the `eval` script.

To run the tests, simply call `run_tests.py` with default parameters. Remember to run `make` on the `sgx-duktape` directory first. Since these benchmarks may take a while, it is also possible to just run a smaller batch first with the `--amount=5` option to verify that the system is set up correctly.

```bash
./run_tests.py -x ../sgx-duktape/app -e ../sgx-duktape/enclave.signed.so
06.02.2020_04:40:42-client_INFO: EVAL RUNNER for SGX+FaaS
06.02.2020_04:40:42-client_INFO: Created directory 2020-02-06_16-40-42_0-1_SGX_RUN
06.02.2020_04:40:42-client_INFO: Using 2020-02-06_16-40-42_0-1_SGX_RUN as base directory for outputs
06.02.2020_04:40:42-client_INFO: Executing for inputs: ['0x3F', '0x43F', '0x83F', '0xC3F', '0x23F', '0x63F', '0xA3F', '0xD3F', '0x33F', '0x73F', '0xB3F', '0xF3F']
100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 12/12 [00:18<00:00,  1.54s/it]
06.02.2020_04:41:01-client_INFO: Executed all input settings. Done.
```

Note, that you can specify `--amount=X` for testing to limit the test size.
By default, the input file with 100 inputs is used. To change that to the another version, use the -m option to change the path. See the Readme in `js-files/extra_mnist-preparation` for information on how to generate other MNist inputs.

## eval.py
The eval script allows to evaluate the outputs generated by the `run_tests.py` script and parse them into a human-readable format (as the outputs generated by the Duktape enclave are all in JSON format). To run the `eval` script, simply give the folder to evaluate as `-p` option. Table 3 is a combination of two runs compiled with the x87 FPU and one run compiled with standard SSE, i.e., the first two groups in Table 3 are compiled with `make FPU_MODE=x87` while the last group (SSE) is simply compiled with `make`.

```bash
./eval.py -p 2020-02-06_18-48-46_0-100_SGX_RUN/
08.06.2020_11:38:29-client_INFO: EVAL RUNNER for SGX+FaaS
08.06.2020_11:38:29-client_INFO: Evaluating files in 2020-02-06_18-48-46_0-100_SGX_RUN
08.06.2020_11:38:29-client_INFO: Ignoring filenames ['input.json']
08.06.2020_11:38:29-client_INFO: Directory has files ['0x23F.log', '0x3F.log', '0x73F.log', '0x43F.log', '0xC3F.log', '0x63F.log', '0xB3F.log', '0xF3F.log', '0xD3F.log', '0xA3F.log', '0x83F.log', '0x33F.log']
08.06.2020_11:38:29-client_INFO: Loaded all files.
08.06.2020_11:38:29-client_INFO: Baseline file 0x33F.log has 100 entries.

Single precision:
CW       Rounding mode     Correct  (Rate)  Class count [0..9]                         Class count difference to baseline [0..9]  Average error                 
0x3F     Round to nearest  4        0.04    [0   12  14  2   10  32  0   30  0   0  ]  [9   2   6   8   4   24  9   16  3   11 ]  0.1760464665270884            
0x43F    Rounding down     8        0.08    [0   0   100 0   0   0   0   0   0   0  ]  [9   14  92  10  14  8   9   14  3   11 ]  0.16796397173637959           
0x83F    Rounding up       4        0.04    [0   12  14  2   10  32  0   30  0   0  ]  [9   2   6   8   4   24  9   16  3   11 ]  0.17604643409291074           
0xC3F    Round to zero     8        0.08    [0   0   100 0   0   0   0   0   0   0  ]  [9   14  92  10  14  8   9   14  3   11 ]  0.1679638755214444            

Double precision:
CW       Rounding mode     Correct  (Rate)  Class count [0..9]                         Class count difference to baseline [0..9]  Average error                 
0x23F    Round to nearest  100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  5.544063573839891e-19         
0x63F    Rounding down     100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  3.3060928102801804e-16        
0xA3F    Rounding up       100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  3.146463688030549e-16         
0xD3F    Round to zero     100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  5.238370318766717e-16         

Extended precision:
CW       Rounding mode     Correct  (Rate)  Class count [0..9]                         Class count difference to baseline [0..9]  Average error                 
0x33F    Round to nearest  100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  0.0                           
0x73F    Rounding down     100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  3.3060928102801804e-16        
0xB3F    Rounding up       100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  3.146463688030549e-16         
0xF3F    Round to zero     100      1.0     [9   14  8   10  14  8   9   14  3   11 ]  [0   0   0   0   0   0   0   0   0   0  ]  5.238370318766717e-16
```